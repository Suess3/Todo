<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App</title>
    
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English&display=swap" rel="stylesheet">

    <style>
        /* --- DESIGN WIE IN DER APP --- */
        body {
            background-color: #121212;
            color: white;
            font-family: 'IM Fell English', serif;
            margin: 0;
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            max-width: 600px; /* Tablet/Laptop Breite */
            padding: 20px;
        }

        /* Versteckt die Scrollbar, aber lässt scrollen zu */
        ::-webkit-scrollbar { display: none; }

        /* --- TAGES-SEKTIONEN --- */
        .day-section {
            margin-bottom: 48px; /* Abstand wie in der App */
        }

        .day-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding-bottom: 8px;
            border-bottom: 1px solid #444;
            user-select: none;
        }

        .weekday {
            font-size: 28px;
            font-weight: bold;
            color: gray;
            text-transform: uppercase;
        }
        .weekday.today { color: #4285F4; }

        .date-small {
            font-size: 14px;
            color: gray;
            margin-left: 12px;
            font-family: 'IM Fell English', serif;
        }

        .toggle-icon {
            margin-left: auto; /* Schiebt Icon nach rechts */
            color: gray;
            font-size: 24px;
            transition: transform 0.2s;
        }
        .toggle-icon.closed { transform: rotate(-90deg); }

        /* --- AUFGABEN LISTE --- */
        .todo-list {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .hidden { display: none; }

        .todo-row {
            display: flex;
            align-items: center;
            padding: 4px;
            transition: opacity 0.2s;
        }
        .todo-row.done { opacity: 0.5; }

        /* Custom Checkbox */
        .checkbox-wrapper {
            padding: 4px;
            cursor: pointer;
        }
        .checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid gray;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }
        .checkbox.checked {
            background-color: #4285F4;
            border-color: #4285F4;
        }
        .checkbox.today-unchecked { border-color: white; }

        /* Das Eingabefeld (sieht aus wie Text) */
        .todo-input {
            background: transparent;
            border: none;
            color: white;
            font-family: 'IM Fell English', serif;
            font-size: 18px; /* App Größe */
            flex-grow: 1;
            margin-left: 12px;
            outline: none;
            padding: 5px 0;
        }
        .todo-input.done { text-decoration: line-through; color: gray !important; }

        /* --- TAP TO ADD BEREICH --- */
        .tap-to-add {
            height: 40px;
            display: flex;
            align-items: center;
            color: #444;
            font-size: 14px;
            cursor: pointer;
            padding-left: 4px;
            margin-top: 8px;
        }
        .tap-to-add:hover { color: #666; }

    </style>
</head>
<body>

<div class="app-container" id="app">
    <div style="text-align:center; margin-top:50px; color:gray;">Lade App...</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, deleteDoc, where } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ==========================================
    // WICHTIG: HIER DEINE CONFIG EINFÜGEN !!!
    // ==========================================
    const firebaseConfig = {

  apiKey: "AIzaSyDULojwaebqfM9f1z7L4JFiUO0eqK9OpBQ",

  authDomain: "todo-28d2e.firebaseapp.com",

  projectId: "todo-28d2e",

  storageBucket: "todo-28d2e.firebasestorage.app",

  messagingSenderId: "640913241762",

  appId: "1:640913241762:web:cdb26cd9a79d061cb609fb",

  measurementId: "G-3CE2KBZ6KY"

};

    // App initialisieren
    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    } catch (e) {
        document.getElementById("app").innerHTML = "<h1>Fehler: Config fehlt!</h1><p>Bitte bearbeite die index.html und füge deine Firebase Config ein.</p>";
    }

    // --- STATE ---
    let allTodos = [];
    // Speichert, welche Tage offen sind (Standard: Heute+Zukunft offen, Gestern zu)
    let expandedStates = {}; 

    // --- DATUM HELFER ---
    const todayEpoch = Math.floor(Date.now() / 86400000);
    const dayNames = ["SONNTAG", "MONTAG", "DIENSTAG", "MITTWOCH", "DONNERSTAG", "FREITAG", "SAMSTAG"];

    function getEpochDay(date) {
        return Math.floor(date.getTime() / 86400000);
    }

    function formatDate(epoch) {
        const d = new Date(epoch * 86400000);
        return d.getDate().toString().padStart(2, '0') + "." + (d.getMonth() + 1).toString().padStart(2, '0') + ".";
    }

    function getDayName(epoch) {
        const d = new Date(epoch * 86400000);
        return dayNames[d.getDay()];
    }

    // --- DATENBANK LISTENER ---
    // Wir laden ALLES (auch Gestern), damit wir die Historie sehen
    const q = query(collection(db, "todos"), orderBy("sortOrder", "asc"));
    
    onSnapshot(q, (snapshot) => {
        allTodos = [];
        snapshot.forEach(doc => {
            allTodos.push({ id: doc.id, ...doc.data() });
        });
        renderApp();
    });

    // --- RENDERING (Die UI bauen) ---
    function renderApp() {
        const container = document.getElementById("app");
        container.innerHTML = "";

        // Wir zeigen Gestern (-1) bis +6 Tage an (wie in der App)
        for (let i = -1; i <= 6; i++) {
            const currentDayEpoch = todayEpoch + i;
            renderDaySection(container, currentDayEpoch);
        }
    }

    function renderDaySection(container, dateEpoch) {
        const isToday = (dateEpoch === todayEpoch);
        const isYesterday = (dateEpoch < todayEpoch);
        
        // Todos für diesen Tag filtern
        const dayTodos = allTodos.filter(t => t.dateEpochDay === dateEpoch);

        // Status initialisieren (falls noch nicht gesetzt)
        if (expandedStates[dateEpoch] === undefined) {
            expandedStates[dateEpoch] = !isYesterday; // Gestern zu, Rest auf
        }
        const isOpen = expandedStates[dateEpoch];

        // 1. Header bauen
        const section = document.createElement("div");
        section.className = "day-section";

        section.innerHTML = `
            <div class="day-header" onclick="toggleSection(${dateEpoch})">
                <span class="weekday ${isToday ? 'today' : ''}">${getDayName(dateEpoch)}</span>
                <span class="date-small">${formatDate(dateEpoch)}</span>
                <span class="toggle-icon ${isOpen ? '' : 'closed'}">▼</span>
            </div>
            <div class="todo-list ${isOpen ? '' : 'hidden'}" id="list-${dateEpoch}">
                </div>
        `;
        
        // 2. Todos einfügen
        const listContainer = section.querySelector(`#list-${dateEpoch}`);
        
        dayTodos.forEach((todo, index) => {
            const row = document.createElement("div");
            row.className = `todo-row ${todo.isDone ? 'done' : ''}`;

            // Farben Logik (Pastell)
            let textColor = "white";
            if (todo.isDone || isYesterday) textColor = "gray";
            else if (todo.moveCount === 1) textColor = "#FFFFE6"; // Gelb
            else if (todo.moveCount === 2) textColor = "#FFEFE0"; // Orange
            else if (todo.moveCount >= 3) textColor = "#FFEBEB"; // Rot

            row.innerHTML = `
                <div class="checkbox-wrapper" onclick="toggleTodo('${todo.id}', ${!todo.isDone})">
                    <div class="checkbox ${todo.isDone ? 'checked' : ''} ${isToday && !todo.isDone ? 'today-unchecked' : ''}">
                        ${todo.isDone ? '✓' : ''}
                    </div>
                </div>
                <input type="text" class="todo-input ${todo.isDone ? 'done' : ''}" 
                    value="${todo.text}" 
                    style="color: ${textColor}"
                    oninput="handleInput(this, '${todo.id}')"
                    onkeydown="handleKey(event, '${todo.id}', ${dateEpoch})"
                >
            `;
            listContainer.appendChild(row);
        });

        // 3. "Tap to add" Button (Nur wenn offen)
        if (isOpen) {
            const addBtn = document.createElement("div");
            addBtn.className = "tap-to-add";
            addBtn.innerText = dayTodos.length === 0 ? "No tasks (tap to add)" : "";
            // Klick auf die ganze Fläche erstellt Todo
            addBtn.onclick = () => addTodo(dateEpoch);
            // Auch wenn leer, soll der Bereich klickbar sein
            addBtn.style.height = "40px";
            addBtn.style.width = "100%";
            
            listContainer.appendChild(addBtn);
        }

        container.appendChild(section);
    }

    // --- LOGIK FUNKTIONEN ---

    // Global verfügbar machen
    window.toggleSection = (dateEpoch) => {
        expandedStates[dateEpoch] = !expandedStates[dateEpoch];
        renderApp(); // UI neu zeichnen
    };

    window.toggleTodo = async (id, newState) => {
        await updateDoc(doc(db, "todos", id), { isDone: newState });
    };

    window.addTodo = async (dateEpoch) => {
        await addDoc(collection(db, "todos"), {
            text: "",
            isDone: false,
            dateEpochDay: dateEpoch,
            sortOrder: Date.now(),
            moveCount: 0
        });
        // Fokus Logik ist im Web schwieriger, wir verlassen uns auf das Re-Render
    };

    // Debouncing für Text-Update (Damit wir die DB nicht spammen)
    let timeout = null;
    window.handleInput = (input, id) => {
        clearTimeout(timeout);
        timeout = setTimeout(async () => {
            await updateDoc(doc(db, "todos", id), { text: input.value });
        }, 500); // 500ms warten nach Tippen
    };

    window.handleKey = async (e, id, dateEpoch) => {
        // Bei Enter -> Neue Zeile darunter
        if (e.key === "Enter") {
            e.preventDefault();
            await addTodo(dateEpoch);
        }
        // Bei Backspace & leer -> Löschen
        if (e.key === "Backspace" && e.target.value === "") {
            e.preventDefault();
            await deleteDoc(doc(db, "todos", id));
        }
    };

</script>

</body>
</html>
